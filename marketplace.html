<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incorp — Marketplace</title>
    <meta name="description" content="Use your earned Tokens to buy exclusive items on the Incorp Marketplace.">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'><path d='m12 3-10 5 10 5 10-5-10-5z'/><path d='m2 12 10 5 10-5'/><path d='m2 17 10 5 10-5'/></svg>">
    <style>
        /* ── Modal ── */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 400px;
            transform: scale(0.95);
            transition: transform 0.2s ease;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal h3 { margin-top: 0; font-size: 1.25rem; margin-bottom: 0.5rem; }
        .modal p { color: var(--fg-3); margin-bottom: 1.5rem; line-height: 1.5; }
        .modal-actions { display: flex; gap: 1rem; justify-content: flex-end; }
        .btn-cancel {
            background: rgba(255,255,255,0.1); color: var(--fg);
            border: none; padding: 0.75rem 1.25rem; border-radius: 6px;
            cursor: pointer; font-weight: 500; transition: background 0.2s;
        }
        .btn-cancel:hover { background: rgba(255,255,255,0.15); }
        .btn-confirm {
            background: #a78bfa; color: #111827;
            border: none; padding: 0.75rem 1.25rem; border-radius: 6px;
            cursor: pointer; font-weight: 600; transition: filter 0.2s;
        }
        .btn-confirm:hover { filter: brightness(1.1); }
        .btn-confirm:disabled { opacity: 0.5; cursor: not-allowed; filter: none; }

        /* ── User bar badge ── */
        .tokens-badge {
            background: rgba(167,139,250,0.15); color: #c4b5fd;
            padding: 0.25rem 0.5rem; border-radius: 4px;
            font-size: 0.85rem; font-weight: 600;
            border: 1px solid rgba(167,139,250,0.3);
        }

        /* ── Tabs ── */
        .store-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 2rem;
            gap: 0;
        }
        .tab-btn {
            background: none; border: none;
            border-bottom: 2px solid transparent;
            color: var(--fg-3);
            font-size: 0.875rem; font-weight: 500;
            padding: 0.625rem 1.25rem;
            cursor: pointer;
            margin-bottom: -1px;
            transition: color 0.15s, border-color 0.15s;
            font-family: var(--font);
        }
        .tab-btn:hover { color: var(--fg-2); }
        .tab-btn.active { color: var(--fg); border-bottom-color: var(--fg); }

        /* ── Category filter pills ── */
        .cat-filter-bar { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem; }
        .cat-btn {
            background: #18181b; border: 1px solid var(--border);
            color: var(--fg-3); font-size: 0.75rem; font-weight: 500;
            padding: 0.3rem 0.75rem; border-radius: 999px;
            cursor: pointer; transition: all 0.15s; font-family: var(--font);
        }
        .cat-btn.active, .cat-btn:hover { background: var(--fg); color: var(--bg); border-color: var(--fg); }

        /* ── Theme grid + cards ── */
        .themes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
            gap: 1rem;
        }
        .theme-card {
            border-radius: 12px; overflow: hidden;
            display: flex; flex-direction: column;
            border: 1px solid var(--border);
            transition: border-color 0.2s, transform 0.2s;
            position: relative;
            background: #111113;
        }
        .theme-card:hover { border-color: var(--border-2); transform: translateY(-2px); }
        .theme-card.is-active {
            border-color: rgba(167,139,250,0.55);
            box-shadow: 0 0 0 1px rgba(167,139,250,0.25);
        }
        .theme-palette { height: 72px; display: flex; }
        .theme-palette-swatch { flex: 1; }
        .theme-body { padding: 0.875rem; flex: 1; display: flex; flex-direction: column; gap: 0.375rem; }
        .theme-cat-badge {
            font-size: 0.65rem; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.06em; padding: 0.15rem 0.5rem; border-radius: 999px;
            display: inline-flex; align-self: flex-start;
        }
        .theme-name { font-size: 0.9375rem; font-weight: 600; margin-top: 0.1rem; }
        .theme-desc { font-size: 0.75rem; color: var(--fg-3); line-height: 1.5; flex: 1; }
        .theme-footer { margin-top: 0.625rem; display: flex; gap: 0.5rem; align-items: center; }
        .theme-price { font-size: 0.75rem; color: var(--fg-4); flex: 1; }
        .btn-theme-action {
            font-size: 0.8rem; font-weight: 600; padding: 0.45rem 0.9rem;
            border-radius: 6px; border: none; cursor: pointer;
            transition: filter 0.2s; font-family: var(--font); white-space: nowrap;
        }
        .btn-theme-action.state-active {
            background: rgba(167,139,250,0.15); color: #a78bfa;
            border: 1px solid rgba(167,139,250,0.35); cursor: default;
        }
        .btn-theme-action.state-equip {
            background: #a78bfa; color: #111827;
        }
        .btn-theme-action.state-equip:hover { filter: brightness(1.1); }
        .btn-theme-action.state-buy {
            background: rgba(167,139,250,0.1);
            border: 1px solid rgba(167,139,250,0.3); color: #a78bfa;
        }
        .btn-theme-action.state-buy:hover { background: rgba(167,139,250,0.18); }
        .btn-theme-action.state-locked {
            background: rgba(255,255,255,0.04); border: 1px solid var(--border);
            color: var(--fg-4); cursor: default;
        }
        .theme-owned-badge {
            position: absolute; top: 0.5rem; right: 0.5rem;
            background: rgba(0,0,0,0.65); border: 1px solid rgba(255,255,255,0.12);
            color: #a78bfa; font-size: 0.6rem; font-weight: 700;
            padding: 0.125rem 0.4rem; border-radius: 4px; text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* ── Store item cards ── */
        .item-card {
            background: linear-gradient(145deg, rgba(20,20,24,1) 0%, rgba(30,30,36,1) 100%);
            padding: 1.5rem; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.05);
            display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative; overflow: hidden;
        }
        .item-card-tag {
            position: absolute; top: 0; right: 0;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
            border-bottom-left-radius: 8px;
        }
    </style>
</head>

<body>

    <header class="site-header">
        <div class="site-header-container">
            <a href="index.html" class="logo">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m12 3-10 5 10 5 10-5-10-5z" />
                    <path d="m2 12 10 5 10-5" />
                    <path d="m2 17 10 5 10-5" />
                </svg>
                incorp
            </a>
            <div class="header-actions">
                <nav class="header-nav" aria-label="Social">
                    <a href="#" aria-label="GitHub"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path
                                d="M15 22v-4a4.8 4.8 0 0 0-1-3.2c3-.3 6-1.5 6-6.5a4.6 4.6 0 0 0-1.3-3.2 4.2 4.2 0 0 0-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3 0 0 0-6.2 0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2 0 0 0-.1 3.2A4.6 4.6 0 0 0 4 9.5c0 5 3 6.2 6 6.5a4.8 4.8 0 0 0-1 3.2v4" />
                        </svg></a>
                    <a href="https://discord.com/users/1333972569014931466" aria-label="Discord" target="_blank"><svg
                            width="18" height="18" viewBox="0 0 127.14 96.36" fill="currentColor">
                            <path
                                d="M107.7 8.07A105.15 105.15 0 0 0 81.47 0a72.06 72.06 0 0 0-3.36 6.83 97.68 97.68 0 0 0-29.11 0A72.37 72.37 0 0 0 45.64 0a105.89 105.89 0 0 0-26.25 8.09C2.79 32.65-1.71 56.6.54 80.21a105.73 105.73 0 0 0 32.17 16.15 77.7 77.7 0 0 0 6.89-11.11 68.42 68.42 0 0 1-10.85-5.18c.91-.66 1.8-1.34 2.66-2.04a75.57 75.57 0 0 0 64.32 0c.87.71 1.76 1.39 2.66 2.04a68.68 68.68 0 0 1-10.87 5.19 77 77 0 0 0 6.89 11.1 105.25 105.25 0 0 0 32.19-16.14c2.64-27.38-4.51-51.11-18.9-72.15zM42.45 65.69C36.18 65.69 31 60 31 53.05s5-12.68 11.45-12.68S53.89 46 53.88 53.05 48.84 65.69 42.45 65.69zm42.24 0C78.41 65.69 73.25 60 73.25 53.05s5-12.68 11.44-12.68S96.23 46 96.12 53.05 91.08 65.69 84.69 65.69z" />
                        </svg></a>
                </nav>
                <button class="mobile-toggle" id="mobileToggle" aria-label="Menu">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="4" x2="20" y1="12" y2="12" />
                        <line x1="4" x2="20" y1="6" y2="6" />
                        <line x1="4" x2="20" y1="18" y2="18" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <div class="site-layout">
        <aside class="site-sidebar" id="sidebar">
            <div class="sidebar-group">
                <h4>Overview</h4>
                <nav class="nav-links">
                    <a href="index.html">Home</a>
                    <a href="index.html#features">Features</a>
                    <a href="index.html#updates">Updates</a>
                    <a href="index.html#stats">Stats</a>
                </nav>
            </div>
            <div class="sidebar-group">
                <h4>Resources</h4>
                <nav class="nav-links">
                    <a href="changelog.html">Changelog</a>
                    <a href="settings.html">Settings</a>
                    <a href="marketplace.html" class="active">Marketplace</a>
                </nav>
            </div>
        </aside>

        <main class="site-main">

            <section class="settings-head reveal">
                <h1>Marketplace</h1>
                <p>Spend your hard-earned Tokens on exclusive items, themes, and perks.</p>
            </section>

            <!-- Login State -->
            <div id="loginView" class="reveal" style="transition-delay:.06s">
                <div class="login-card">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                        style="color:var(--fg-3); margin-bottom: 0.5rem">
                        <circle cx="12" cy="8" r="5" />
                        <path d="M20 21a8 8 0 0 0-16 0" />
                    </svg>
                    <h3 style="font-size: 1rem; font-weight: 600;">Sign in to access the marketplace</h3>
                    <p>Connect your Discord account to view your Tokens and proceed with purchases.</p>
                    <button class="btn-discord" id="loginBtn">
                        <svg width="20" height="20" viewBox="0 0 71 55" fill="currentColor">
                            <path
                                d="M60.1 4.9A58.5 58.5 0 0 0 45.5.2a.2.2 0 0 0-.2.1 40.8 40.8 0 0 0-1.8 3.7 54 54 0 0 0-16.2 0A37.4 37.4 0 0 0 25.5.3a.2.2 0 0 0-.2-.1A58.4 58.4 0 0 0 10.7 4.9a.2.2 0 0 0-.1.1C1.5 18.7-.9 32.2.3 45.4v.2a58.7 58.7 0 0 0 17.7 9 .2.2 0 0 0 .3-.1 42 42 0 0 0 3.6-5.9.2.2 0 0 0-.1-.3 38.6 38.6 0 0 1-5.5-2.6.2.2 0 0 1 0-.4l1.1-.9a.2.2 0 0 1 .2 0 41.9 41.9 0 0 0 35.6 0 .2.2 0 0 1 .2 0l1.1.9a.2.2 0 0 1 0 .4 36.4 36.4 0 0 1-5.5 2.6.2.2 0 0 0-.1.3 47.2 47.2 0 0 0 3.6 5.9.2.2 0 0 0 .3.1 58.5 58.5 0 0 0 17.7-9 .2.2 0 0 0 .1-.2c1.4-15-2.3-28-9.9-39.6a.2.2 0 0 0-.1-.1zM23.7 37.3c-3.4 0-6.3-3.2-6.3-7s2.8-7 6.3-7 6.4 3.2 6.3 7-2.8 7-6.3 7zm23.3 0c-3.4 0-6.3-3.2-6.3-7s2.8-7 6.3-7 6.4 3.2 6.3 7-2.8 7-6.3 7z" />
                        </svg>
                        Continue with Discord
                    </button>
                </div>
            </div>

            <!-- Logged-in State -->
            <div id="settingsView" style="display:none">

                <div class="user-bar reveal" style="justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div class="user-avatar" id="userAvatar">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="8" r="5" />
                                <path d="M20 21a8 8 0 0 0-16 0" />
                            </svg>
                        </div>
                        <div class="user-info">
                            <strong id="userName">User</strong>
                            <span id="userTag">#0000</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <span class="tokens-badge" id="tokenDisplay" title="Earned by leveling up and streaks!">
                            Loading...
                        </span>
                        <button class="btn-logout" id="logoutBtn" style="padding: 0.4rem 0.75rem;">Sign out</button>
                    </div>
                </div>

                <div class="settings-section reveal" id="storeArea" style="margin-top: 2rem;">

                    <!-- Tab nav -->
                    <div class="store-tabs">
                        <button class="tab-btn active" data-tab="items">Store Items</button>
                        <button class="tab-btn" data-tab="themes">Profile Themes</button>
                        <button class="tab-btn" data-tab="profile">Profile Settings</button>
                    </div>

                    <!-- ── STORE ITEMS TAB ── -->
                    <div id="itemsTab">
                        <p style="color: var(--fg-3); font-size: 0.875rem; margin-bottom: 1.5rem;">
                            You earn 1 Token for every level you achieve, and more tokens for claiming your
                            <code>.daily</code> streak. Some items require you to be a certain Level before you can buy
                            them.
                        </p>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem;">

                            <!-- 1M Coins -->
                            <div class="item-card">
                                <div>
                                    <h4 style="margin: 0 0 0.5rem 0; color: var(--fg); display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem;">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fcd34d" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"></path>
                                            <path d="M12 18V6"></path>
                                        </svg>
                                        1,000,000 Coins
                                    </h4>
                                    <p style="font-size: 0.9rem; color: var(--fg-3); margin: 0 0 1.5rem 0; line-height: 1.4;">
                                        Trade in your Tokens for a massive deposit directly into your bot wallet.
                                    </p>
                                    <p style="font-size: 0.85rem; color: #a78bfa; margin-bottom: 1rem; font-weight: 500;">Req: Level 2</p>
                                </div>
                                <button class="buy-btn" data-id="1m_coins" data-name="1,000,000 Coins" data-tokens="2" data-coins="0" data-req-level="2"
                                    style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--fg); padding: 0.75rem; border-radius: 8px; font-weight: 500; font-size: 0.9rem; cursor: pointer; transition: background 0.2s;">
                                    Purchase — 2 Tokens
                                </button>
                            </div>

                            <!-- VIP Badge -->
                            <div class="item-card">
                                <div>
                                    <h4 style="margin: 0 0 0.5rem 0; color: #ef4444; display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem;">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="m12 14 4-4" /><path d="M3.34 19a10 10 0 1 1 17.32 0" />
                                        </svg>
                                        VIP Status Badge
                                    </h4>
                                    <p style="font-size: 0.9rem; color: var(--fg-3); margin: 0 0 1.5rem 0; line-height: 1.4;">
                                        A shiny VIP badge on your profile. Costs a ton of coins to prove your wealth.
                                    </p>
                                    <p style="font-size: 0.85rem; color: #a78bfa; margin-bottom: 1rem; font-weight: 500;">Req: Level 10</p>
                                </div>
                                <button class="buy-btn" data-id="vip_role" data-name="VIP Status Badge" data-tokens="10" data-coins="5000000" data-req-level="10"
                                    style="background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: #ef4444; padding: 0.75rem; border-radius: 8px; font-weight: 500; font-size: 0.9rem; cursor: pointer; transition: background 0.2s;">
                                    Purchase — 10 Tokens + 5M Coins
                                </button>
                            </div>

                            <!-- Autofish Access -->
                            <div class="item-card">
                                <div>
                                    <h4 style="margin: 0 0 0.5rem 0; color: #14b8a6; display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem;">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#14b8a6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                                            <line x1="4" y1="22" x2="4" y2="15"></line>
                                        </svg>
                                        Autofish Access
                                    </h4>
                                    <p style="font-size: 0.9rem; color: var(--fg-3); margin: 0 0 1.5rem 0; line-height: 1.4;">
                                        Gain access to the <code>.autofish</code> command. Automatically fishes for you when you're active, up to 2 hours every day.
                                    </p>
                                    <p style="font-size: 0.85rem; color: #a78bfa; margin-bottom: 1rem; font-weight: 500;">Req: Level 3</p>
                                </div>
                                <button class="buy-btn" data-id="autofish_access" data-name="Autofish Access" data-tokens="15" data-coins="0" data-req-level="3"
                                    style="background: rgba(20,184,166,0.1); border: 1px solid rgba(20,184,166,0.3); color: #14b8a6; padding: 0.75rem; border-radius: 8px; font-weight: 500; font-size: 0.9rem; cursor: pointer; transition: background 0.2s;">
                                    Purchase — 15 Tokens
                                </button>
                            </div>

                        </div>
                    </div><!-- /itemsTab -->

                    <!-- ── THEMES TAB ── -->
                    <div id="themesTab" style="display:none">
                        <p style="color: var(--fg-3); font-size: 0.875rem; margin-bottom: 1.25rem;">
                            Customize your <code>.profile</code> card with a theme. Standard themes are free — Premium
                            and Seasonal themes require Tokens. Exclusive themes are earned, not bought.<br>
                            After purchasing, click <strong>Equip</strong> to activate a theme on your profile.
                        </p>

                        <div class="cat-filter-bar">
                            <button class="cat-btn active" data-cat="all">All</button>
                            <button class="cat-btn" data-cat="standard">Standard</button>
                            <button class="cat-btn" data-cat="premium">Premium</button>
                            <button class="cat-btn" data-cat="seasonal">Seasonal</button>
                            <button class="cat-btn" data-cat="exclusive">Exclusive</button>
                        </div>

                        <div class="themes-grid" id="themesGrid">
                            <p style="color:var(--fg-4); font-size:0.875rem;">Loading themes...</p>
                        </div>
                    </div><!-- /themesTab -->

                    <!-- ── PROFILE SETTINGS TAB ── -->
                    <div id="profileTab" style="display:none">
                        <p style="color: var(--fg-3); font-size: 0.875rem; margin-bottom: 1.75rem;">
                            Customize how your <code>.profile</code> card looks. Changes save instantly.
                        </p>

                        <!-- Bio -->
                        <div style="margin-bottom: 1.75rem;">
                            <label style="display:block; font-size:0.875rem; font-weight:600; color:var(--fg-2); margin-bottom:0.5rem;">
                                About / Bio
                            </label>
                            <textarea id="bioInput" maxlength="120" rows="3" placeholder="Write something about yourself... (max 120 chars)"
                                style="width:100%; box-sizing:border-box; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:8px; color:var(--fg); padding:0.75rem; font-size:0.9rem; resize:vertical; font-family:inherit; outline:none;"></textarea>
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:0.5rem;">
                                <span id="bioCharCount" style="font-size:0.75rem; color:var(--fg-4);">0 / 120</span>
                                <button id="saveBioBtn"
                                    style="background:rgba(88,101,242,0.2); border:1px solid rgba(88,101,242,0.4); color:#a5b4fc; padding:0.45rem 1.1rem; border-radius:6px; font-size:0.85rem; font-weight:600; cursor:pointer;">
                                    Save Bio
                                </button>
                            </div>
                            <p id="bioStatus" style="font-size:0.8rem; color:var(--fg-4); margin-top:0.4rem; min-height:1rem;"></p>
                        </div>
                    </div><!-- /profileTab -->

                </div><!-- /storeArea -->

            </div><!-- /settingsView -->

        </main>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <h3 id="modalTitle">Confirm Purchase</h3>
            <p id="modalDesc">Are you sure you want to buy <strong>Item</strong> for <span id="modalCost"></span>?</p>
            <div id="modalError" style="color: #ef4444; font-size: 0.85rem; margin-bottom: 1rem; display: none;"></div>
            <div class="modal-actions">
                <button class="btn-cancel" id="btnCancel">Cancel</button>
                <button class="btn-confirm" id="btnConfirm">Yes, I want to buy this</button>
            </div>
        </div>
    </div>

    <script>
        const CLIENT_ID = '1474880055980195953';
        const REDIRECT_URI = location.hostname === 'localhost' || location.hostname === '127.0.0.1'
            ? location.origin + '/marketplace.html'
            : 'https://incorp.live/marketplace.html';
        const OAUTH_URL = `https://discord.com/api/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=identify`;

        const SB_URL = 'https://pwbvvzskdzuccnskduiz.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3YnZ2enNrZHp1Y2Nuc2tkdWl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MDcyMTMsImV4cCI6MjA4NzI4MzIxM30.r5G_RQgEkudLkSLn4QUBviJAzum3tHm2Z4zqytxl1kQ';

        const STORE_TOKEN = 'incorp_token';
        const STORE_USER  = 'incorp_user';

        const sbHeaders = {
            apikey: SB_KEY,
            Authorization: `Bearer ${SB_KEY}`,
            'Content-Type': 'application/json',
            Prefer: 'return=representation'
        };

        // ── Theme catalog (mirrors ./data/themes_catalog.json) ──────────────────
        const THEMES_CATALOG = {
            categories: {
                standard:  { label: 'Standard',  color: '#71717a' },
                premium:   { label: 'Premium',   color: '#a78bfa' },
                seasonal:  { label: 'Seasonal',  color: '#34d399' },
                exclusive: { label: 'Exclusive', color: '#fbbf24' }
            },
            themes: {
                default:      { id: 'default',      name: 'Default',      category: 'standard',  tokens: 0, coins: 0, reqLevel: 0, desc: 'The classic Incorp look.',                        colors: ['#5865F2','#7289DA','#2C2F33','#4F545C'] },
                midnight:     { id: 'midnight',     name: 'Midnight',     category: 'standard',  tokens: 0, coins: 0, reqLevel: 0, desc: 'Deep navy, built for night owls.',               colors: ['#1A3A5C','#2D6080','#040C16','#0A1828'] },
                sakura:       { id: 'sakura',       name: 'Sakura',       category: 'premium',   tokens: 4, coins: 0, reqLevel: 3, desc: 'Cherry blossom season, forever.',                colors: ['#E8A0BF','#F4C2D5','#2D1A24','#3D2230'] },
                inferno:      { id: 'inferno',      name: 'Inferno',      category: 'premium',   tokens: 5, coins: 0, reqLevel: 5, desc: 'The market burns. So do you.',                    colors: ['#CC2200','#FF5500','#0A0000','#2A0500'] },
                ocean:        { id: 'ocean',        name: 'Ocean',        category: 'premium',   tokens: 4, coins: 0, reqLevel: 3, desc: 'Depths unknown. Riches immeasurable.',            colors: ['#00A896','#40E8C8','#002030','#003840'] },
                arctic:       { id: 'arctic',       name: 'Arctic',       category: 'premium',   tokens: 3, coins: 0, reqLevel: 3, desc: 'Cold, clean, untouchable.',                       colors: ['#B0C4DE','#E8F4FD','#0F1923','#1A2D40'] },
                neon:         { id: 'neon',         name: 'Neon',         category: 'premium',   tokens: 6, coins: 0, reqLevel: 8, desc: 'Cyberpunk grid, flickering economy.',             colors: ['#00FF41','#FF00FF','#0D0D0D','#001A00'] },
                sunset:       { id: 'sunset',       name: 'Sunset',       category: 'premium',   tokens: 5, coins: 0, reqLevel: 5, desc: 'Everything ends. Make it beautiful.',              colors: ['#FF6B35','#FF9E4A','#1A0A14','#2D1020'] },
                emerald:      { id: 'emerald',      name: 'Emerald',      category: 'premium',   tokens: 5, coins: 0, reqLevel: 5, desc: 'Old money energy.',                               colors: ['#2ECC71','#27AE60','#0D1F10','#143020'] },
                obsidian:     { id: 'obsidian',     name: 'Obsidian',     category: 'premium',   tokens: 5, coins: 0, reqLevel: 5, desc: 'Dark feather mystique. Darkness given form.',     colors: ['#7040B0','#9060D0','#080618','#1E0838'] },
                winter:       { id: 'winter',       name: 'Winter',       category: 'seasonal',  tokens: 3, coins: 0, reqLevel: 2, desc: 'Limited seasonal drop. Frosty.',                  colors: ['#A8D8EA','#CBE8F5','#0F1F2E','#1A2E3D'] },
                halloween:    { id: 'halloween',    name: 'Halloween',    category: 'seasonal',  tokens: 2, coins: 0, reqLevel: 2, desc: 'Limited seasonal drop. Spooky.',                  colors: ['#FF6600','#CC00CC','#0D0D0D','#1A0000'] },
                legend_gold:  { id: 'legend_gold',  name: 'Legend Gold',  category: 'exclusive', tokens: 0, coins: 0, reqLevel: 999, desc: 'Top 10 all-time. Cannot be purchased.',         colors: ['#FFD700','#FFA500','#1A1200','#2D2000'] },
                founders:     { id: 'founders',     name: 'Founders',     category: 'exclusive', tokens: 0, coins: 0, reqLevel: 999, desc: 'Early Incorp supporter. You were here first.',  colors: ['#8B5CF6','#A78BFA','#0F0A1E','#1E1040'] }
            }
        };

        // ── State ────────────────────────────────────────────────────────────────
        const toggle   = document.getElementById('mobileToggle');
        const sidebar  = document.getElementById('sidebar');
        toggle?.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
        });

        const io = new IntersectionObserver(entries => {
            entries.forEach(e => { if (e.isIntersecting) { e.target.classList.add('visible'); io.unobserve(e.target); } });
        }, { threshold: 0.05 });
        document.querySelectorAll('.reveal').forEach(el => io.observe(el));

        function getToken() { return localStorage.getItem(STORE_TOKEN); }
        function getUser()  { try { return JSON.parse(localStorage.getItem(STORE_USER)); } catch { return null; } }

        function avatarUrl(user) {
            if (user.avatar) return `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.${user.avatar.startsWith('a_') ? 'gif' : 'webp'}?size=80`;
            const idx = user.discriminator === '0' ? (BigInt(user.id) >> 22n) % 6n : parseInt(user.discriminator) % 5;
            return `https://cdn.discordapp.com/embed/avatars/${idx}.png`;
        }

        let currentDiscordId = null;
        let userStats        = null;
        let selectedItem     = null;
        let ownedThemes      = new Set();
        let activeTheme      = 'default';
        let currentThemeCat  = 'all';

        // ── Supabase helpers ─────────────────────────────────────────────────────
        async function sbLoadStats(discordId) {
            try {
                const res  = await fetch(`${SB_URL}/rest/v1/user_stats?discord_id=eq.${discordId}&select=*`, { headers: sbHeaders });
                const rows = await res.json();
                if (rows.length > 0) {
                    userStats = rows[0];
                    document.getElementById('tokenDisplay').textContent =
                        `${userStats.tokens || 0} Tokens | ${Number(userStats.balance || 0).toLocaleString()} Coins | Lvl ${userStats.level || 0}`;
                } else {
                    document.getElementById('tokenDisplay').textContent = '0 Tokens';
                    userStats = { tokens: 0, level: 0, balance: 0 };
                }
            } catch (err) {
                console.warn('Supabase stats load failed:', err);
                document.getElementById('tokenDisplay').textContent = 'Failed to load';
            }
        }

        async function sbLoadThemeData(discordId) {
            // Always own standard/free themes
            Object.values(THEMES_CATALOG.themes)
                .filter(t => t.category === 'standard')
                .forEach(t => ownedThemes.add(t.id));

            try {
                // Active theme from user_settings
                const sr = await fetch(`${SB_URL}/rest/v1/user_settings?discord_id=eq.${discordId}&select=active_theme`, { headers: sbHeaders });
                const srows = await sr.json();
                if (srows.length > 0 && srows[0].active_theme) activeTheme = srows[0].active_theme;

                // Owned themes from marketplace_purchases (fulfilled)
                const pr = await fetch(`${SB_URL}/rest/v1/marketplace_purchases?discord_id=eq.${discordId}&fulfilled=eq.true&select=item_id`, { headers: sbHeaders });
                const purchases = await pr.json();
                for (const p of purchases) {
                    // Support both 'theme_obsidian' and legacy 'obsidian_theme'
                    if (p.item_id.startsWith('theme_')) ownedThemes.add(p.item_id.slice(6));
                    else if (p.item_id.endsWith('_theme')) ownedThemes.add(p.item_id.replace('_theme', ''));
                }
            } catch (err) {
                console.warn('Theme data load failed:', err);
            }
        }

        async function equipTheme(themeId) {
            if (!currentDiscordId) return;
            try {
                // Try PATCH first; if no row exists, POST with upsert
                const r = await fetch(`${SB_URL}/rest/v1/user_settings?discord_id=eq.${currentDiscordId}`, {
                    method: 'PATCH',
                    headers: { ...sbHeaders, Prefer: 'return=minimal' },
                    body: JSON.stringify({ active_theme: themeId })
                });
                // If nothing was updated (no existing row), insert
                if (r.status === 200 || r.status === 204) {
                    const check = await fetch(`${SB_URL}/rest/v1/user_settings?discord_id=eq.${currentDiscordId}&select=discord_id`, { headers: sbHeaders });
                    const rows = await check.json();
                    if (rows.length === 0) {
                        await fetch(`${SB_URL}/rest/v1/user_settings`, {
                            method: 'POST',
                            headers: { ...sbHeaders, Prefer: 'resolution=merge-duplicates,return=minimal' },
                            body: JSON.stringify({ discord_id: currentDiscordId, active_theme: themeId })
                        });
                    }
                }
                activeTheme = themeId;
                renderThemes(currentThemeCat);
            } catch {
                alert('Failed to equip theme. Please try again.');
            }
        }

        // ── Theme renderer ───────────────────────────────────────────────────────
        function renderThemes(cat) {
            currentThemeCat = cat;
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.toggle('active', b.dataset.cat === cat));

            const grid   = document.getElementById('themesGrid');
            const themes = Object.values(THEMES_CATALOG.themes)
                .filter(t => cat === 'all' || t.category === cat);

            grid.innerHTML = themes.map(t => {
                const catInfo   = THEMES_CATALOG.categories[t.category];
                const isOwned   = ownedThemes.has(t.id);
                const isActive  = activeTheme === t.id;
                const isExcl    = t.category === 'exclusive';

                const palette = t.colors.map(c =>
                    `<div class="theme-palette-swatch" style="background:${c}"></div>`
                ).join('');

                let badgeBg, badgeColor;
                switch (t.category) {
                    case 'premium':   badgeBg = 'rgba(167,139,250,.15)'; badgeColor = '#a78bfa'; break;
                    case 'seasonal':  badgeBg = 'rgba(52,211,153,.15)';  badgeColor = '#34d399'; break;
                    case 'exclusive': badgeBg = 'rgba(251,191,36,.15)';  badgeColor = '#fbbf24'; break;
                    default:          badgeBg = 'rgba(113,113,122,.15)'; badgeColor = '#71717a';
                }

                let actionBtn;
                if (isActive) {
                    actionBtn = `<button class="btn-theme-action state-active" disabled>✓ Active</button>`;
                } else if (isOwned) {
                    actionBtn = `<button class="btn-theme-action state-equip" onclick="equipTheme('${t.id}')">Equip</button>`;
                } else if (isExcl) {
                    actionBtn = `<button class="btn-theme-action state-locked" disabled>Locked</button>`;
                } else {
                    actionBtn = `<button class="btn-theme-action state-buy buy-btn"
                        data-id="theme_${t.id}" data-name="${t.name} Theme"
                        data-tokens="${t.tokens}" data-coins="${t.coins}" data-req-level="${t.reqLevel}">
                        ${t.tokens > 0 ? `${t.tokens} Tokens` : 'Free'}
                    </button>`;
                }

                const priceLabel = isExcl ? 'Earned only' : isOwned ? 'Owned' : (t.tokens > 0 ? `${t.tokens} Tokens` : 'Free');

                return `
                    <div class="theme-card${isActive ? ' is-active' : ''}">
                        ${isOwned && !isActive ? '<div class="theme-owned-badge">Owned</div>' : ''}
                        <div class="theme-palette">${palette}</div>
                        <div class="theme-body">
                            <span class="theme-cat-badge" style="background:${badgeBg};color:${badgeColor}">${catInfo.label}</span>
                            <div class="theme-name">${t.name}</div>
                            <div class="theme-desc">${t.desc}</div>
                            <div class="theme-footer">
                                <span class="theme-price">${priceLabel}</span>
                                ${actionBtn}
                            </div>
                        </div>
                    </div>`;
            }).join('');

            // Re-bind buy buttons rendered in the themes grid
            document.querySelectorAll('#themesGrid .buy-btn').forEach(btn => {
                btn.addEventListener('click', () => openModal(btn.dataset));
            });
        }

        // ── Modal ────────────────────────────────────────────────────────────────
        function openModal(item) {
            selectedItem = item;
            let costParts = [];
            if (parseInt(item.tokens) > 0) costParts.push(`${item.tokens} Tokens`);
            if (parseInt(item.coins)  > 0) costParts.push(`${Number(item.coins).toLocaleString()} Coins`);

            document.getElementById('modalTitle').textContent = 'Confirm Purchase';
            document.getElementById('modalDesc').innerHTML =
                `Are you sure you want to buy <strong>${item.name}</strong> for ${costParts.join(' and ')}?`;
            document.getElementById('modalError').style.display = 'none';

            const btn = document.getElementById('btnConfirm');
            btn.disabled = false;

            if (userStats) {
                if ((userStats.level || 0) < parseInt(item.reqLevel)) {
                    document.getElementById('modalError').textContent = `You must be Level ${item.reqLevel} to purchase this.`;
                    document.getElementById('modalError').style.display = 'block';
                    btn.disabled = true;
                } else if ((userStats.tokens || 0) < parseInt(item.tokens)) {
                    document.getElementById('modalError').textContent = `You need ${item.tokens} Tokens. You have ${userStats.tokens}.`;
                    document.getElementById('modalError').style.display = 'block';
                    btn.disabled = true;
                } else if ((userStats.balance || 0) < parseInt(item.coins)) {
                    document.getElementById('modalError').textContent = `You need ${Number(item.coins).toLocaleString()} Coins.`;
                    document.getElementById('modalError').style.display = 'block';
                    btn.disabled = true;
                }
            }

            document.getElementById('confirmModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('confirmModal').classList.remove('active');
            selectedItem = null;
        }

        async function purchaseItem() {
            if (!selectedItem || !currentDiscordId) return;
            const btn   = document.getElementById('btnConfirm');
            const errEl = document.getElementById('modalError');
            btn.textContent = 'Processing...';
            btn.disabled    = true;
            errEl.style.display = 'none';

            try {
                await fetch(`${SB_URL}/rest/v1/marketplace_purchases`, {
                    method: 'POST',
                    headers: sbHeaders,
                    body: JSON.stringify({
                        discord_id:   currentDiscordId,
                        item_id:      selectedItem.id,
                        cost_tokens:  parseInt(selectedItem.tokens),
                        cost_coins:   parseInt(selectedItem.coins)
                    })
                });

                // Optimistic stat update
                if (userStats) {
                    if (parseInt(selectedItem.tokens) > 0) userStats.tokens  -= parseInt(selectedItem.tokens);
                    if (parseInt(selectedItem.coins)  > 0) userStats.balance -= parseInt(selectedItem.coins);
                    document.getElementById('tokenDisplay').textContent =
                        `${userStats.tokens} Tokens | ${Number(userStats.balance).toLocaleString()} Coins | Lvl ${userStats.level}`;
                }

                // If this was a theme purchase: add to owned set and re-render
                if (selectedItem.id.startsWith('theme_')) {
                    const themeId = selectedItem.id.slice(6);
                    ownedThemes.add(themeId);
                    renderThemes(currentThemeCat);
                }

                closeModal();
                alert(`Purchase submitted! The bot will process this within a few seconds and DM you on Discord.`);
            } catch {
                errEl.textContent = 'Error communicating with server. Try again.';
                errEl.style.display = 'block';
            } finally {
                btn.textContent = 'Yes, I want to buy this';
                btn.disabled    = false;
            }
        }

        document.getElementById('btnCancel').addEventListener('click', closeModal);
        document.getElementById('btnConfirm').addEventListener('click', purchaseItem);

        // ── Tab switching ────────────────────────────────────────────────────────
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
                document.getElementById('itemsTab').style.display   = tab === 'items'   ? '' : 'none';
                document.getElementById('themesTab').style.display  = tab === 'themes'  ? '' : 'none';
                document.getElementById('profileTab').style.display = tab === 'profile' ? '' : 'none';
                if (tab === 'themes') renderThemes(currentThemeCat);
                if (tab === 'profile') loadBio();
            });
        });

        // ── Profile tab — Bio ────────────────────────────────────────────────────
        async function loadBio() {
            const user = getUser();
            if (!user) return;
            try {
                const res  = await fetch(`${SB_URL}/rest/v1/user_settings?discord_id=eq.${user.id}&select=bio`, { headers: sbHeaders });
                const rows = await res.json();
                const bio  = (rows[0] && rows[0].bio) || '';
                document.getElementById('bioInput').value = bio;
                document.getElementById('bioCharCount').textContent = `${bio.length} / 120`;
            } catch { /* silently ignore pre-login */ }
        }

        document.getElementById('bioInput').addEventListener('input', function () {
            document.getElementById('bioCharCount').textContent = `${this.value.length} / 120`;
        });

        document.getElementById('saveBioBtn').addEventListener('click', async () => {
            const user = getUser();
            if (!user) return;
            const bio    = document.getElementById('bioInput').value.trim();
            const status = document.getElementById('bioStatus');
            const btn    = document.getElementById('saveBioBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            try {
                await fetch(`${SB_URL}/rest/v1/user_settings?discord_id=eq.${user.id}`, {
                    method: 'PATCH',
                    headers: { ...sbHeaders, 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                    body: JSON.stringify({ bio: bio.slice(0, 120) })
                });
                status.style.color = '#86efac';
                status.textContent = 'Saved!';
                setTimeout(() => status.textContent = '', 3000);
            } catch {
                status.style.color = '#fca5a5';
                status.textContent = 'Failed to save. Try again.';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Save Bio';
            }
        });

        // ── Category filter buttons ──────────────────────────────────────────────
        document.querySelectorAll('.cat-btn').forEach(btn => {
            btn.addEventListener('click', () => renderThemes(btn.dataset.cat));
        });

        // ── Store item buy buttons ───────────────────────────────────────────────
        document.querySelectorAll('#itemsTab .buy-btn').forEach(btn => {
            btn.addEventListener('click', () => openModal(btn.dataset));
        });

        // ── Auth & init ──────────────────────────────────────────────────────────
        function renderUser(user) {
            document.getElementById('loginView').style.display    = 'none';
            document.getElementById('settingsView').style.display = 'block';
            document.getElementById('userName').textContent = user.global_name || user.username;
            document.getElementById('userTag').textContent  = user.discriminator === '0' ? '@' + user.username : '#' + user.discriminator;
            const av = document.getElementById('userAvatar');
            av.innerHTML = `<img src="${avatarUrl(user)}" alt="" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
        }

        function showLoggedOut() {
            document.getElementById('loginView').style.display    = 'block';
            document.getElementById('settingsView').style.display = 'none';
        }

        async function init() {
            const fragment = new URLSearchParams(window.location.hash.slice(1));
            const newToken = fragment.get('access_token');
            if (newToken) {
                window.history.replaceState(null, '', window.location.pathname);
                localStorage.setItem(STORE_TOKEN, newToken);
            }

            const token = getToken();
            if (!token) return showLoggedOut();

            try {
                const res  = await fetch('https://discord.com/api/users/@me', { headers: { Authorization: `Bearer ${token}` } });
                if (!res.ok) throw new Error('Token expired');
                const user = await res.json();
                localStorage.setItem(STORE_USER, JSON.stringify(user));
                currentDiscordId = user.id;
                renderUser(user);

                await Promise.all([
                    sbLoadStats(user.id),
                    sbLoadThemeData(user.id)
                ]);

                document.querySelectorAll('#settingsView .reveal').forEach(el => {
                    el.classList.remove('visible');
                    requestAnimationFrame(() => io.observe(el));
                });
            } catch {
                const cached = getUser();
                if (cached) {
                    currentDiscordId = cached.id;
                    renderUser(cached);
                    await Promise.all([
                        sbLoadStats(cached.id),
                        sbLoadThemeData(cached.id)
                    ]);
                } else {
                    localStorage.removeItem(STORE_TOKEN);
                    showLoggedOut();
                }
            }
        }

        document.getElementById('loginBtn').addEventListener('click', () => window.location.href = OAUTH_URL);
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem(STORE_USER);
            localStorage.removeItem(STORE_TOKEN);
            currentDiscordId = null;
            ownedThemes.clear();
            activeTheme = 'default';
            showLoggedOut();
        });

        init();
    </script>
</body>

</html>
